<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Голосование за лучшего футболиста России</title>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
    <style>
        /* Основные стили (остаются как в предыдущей версии) */
        
        /* Стили для шахматной таблицы */
        .matrix-container {
            overflow: auto;
            max-height: 80vh;
            margin-top: 20px;
        }
        
        #matrixTable {
            border-collapse: collapse;
            font-size: 14px;
        }
        
        #matrixTable th, #matrixTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 40px;
            height: 40px;
        }
        
        #matrixTable th {
            position: sticky;
            top: 0;
            background: #006400;
            color: white;
            z-index: 10;
        }
        
        #matrixTable th:first-child {
            left: 0;
            z-index: 20;
        }
        
        #matrixTable td:first-child {
            position: sticky;
            left: 0;
            background: white;
            font-weight: bold;
            z-index: 5;
        }
        
        .cell-win {
            background-color: #4CAF50;
            color: white;
        }
        
        .cell-draw {
            background-color: #FFC107;
        }
        
        .cell-loss {
            background-color: #F44336;
            color: white;
        }
        
        .cell-empty {
            background-color: #f9f9f9;
        }
        
        /* Стили для вкладки интересных фактов */
        .facts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .fact-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #006400;
        }
        
        .fact-card.highlight {
            border-left-color: #FFC107;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,193,7,0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255,193,7,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,193,7,0); }
        }
        
        .fact-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #006400;
        }
        
        .fact-player {
            font-weight: bold;
            color: #006400;
        }
        
        .fact-value {
            font-weight: bold;
            color: #F44336;
        }
    </style>
</head>
<body>
    <!-- Остальная разметка (как в предыдущей версии) -->
    
    <!-- Добавляем новую вкладку -->
    <div id="matrix" class="tab-content">
        <h2>Матрица встреч</h2>
        <div class="matrix-container">
            <table id="matrixTable">
                <thead>
                    <tr>
                        <th>Игрок \ Игрок</th>
                        <!-- Заголовки будут заполнены скриптом -->
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div id="facts" class="tab-content">
        <h2>Интересные факты</h2>
        <div class="facts-container" id="factsContainer">
            <!-- Факты будут добавляться динамически -->
        </div>
    </div>

    <script>
        // Конфигурация Firebase и инициализация (как в предыдущей версии)
        
        // Новые переменные
        let playerStats = {}; // Для отслеживания статистики игроков
        let interestingFacts = []; // Массив интересных фактов
        
        // После загрузки данных инициализируем статистику
        function initializePlayerStats() {
            players.forEach(player => {
                playerStats[player.id] = {
                    currentWinStreak: 0,
                    currentDrawStreak: 0,
                    currentLossStreak: 0,
                    maxWinStreak: 0,
                    maxDrawStreak: 0,
                    maxLossStreak: 0,
                    totalWins: 0,
                    totalDraws: 0,
                    totalLosses: 0
                };
            });
            
            // Анализируем историю для заполнения статистики
            history.forEach(match => {
                updatePlayerStatsAfterMatch(match);
            });
        }
        
        // Обновление статистики после матча
        function updatePlayerStatsAfterMatch(match) {
            const player1Id = match.player1Id;
            const player2Id = match.player2Id;
            const result = match.resultValue;
            
            // Обрабатываем первого игрока
            updatePlayerStatsSingle(player1Id, result === 1 ? 'win' : (result === 0 ? 'draw' : 'loss'));
            
            // Обрабатываем второго игрока
            updatePlayerStatsSingle(player2Id, result === 2 ? 'win' : (result === 0 ? 'draw' : 'loss'));
            
            // Проверяем интересные факты
            checkForInterestingFacts(match);
        }
        
        // Обновление статистики одного игрока
        function updatePlayerStatsSingle(playerId, result) {
            const stats = playerStats[playerId];
            
            // Сбрасываем противоположные серии
            if (result !== 'win') stats.currentWinStreak = 0;
            if (result !== 'draw') stats.currentDrawStreak = 0;
            if (result !== 'loss') stats.currentLossStreak = 0;
            
            // Увеличиваем текущую серию
            if (result === 'win') {
                stats.currentWinStreak++;
                stats.totalWins++;
                if (stats.currentWinStreak > stats.maxWinStreak) {
                    stats.maxWinStreak = stats.currentWinStreak;
                }
            } 
            else if (result === 'draw') {
                stats.currentDrawStreak++;
                stats.totalDraws++;
                if (stats.currentDrawStreak > stats.maxDrawStreak) {
                    stats.maxDrawStreak = stats.currentDrawStreak;
                }
            } 
            else {
                stats.currentLossStreak++;
                stats.totalLosses++;
                if (stats.currentLossStreak > stats.maxLossStreak) {
                    stats.maxLossStreak = stats.currentLossStreak;
                }
            }
        }
        
        // Проверка на интересные факты
        function checkForInterestingFacts(match) {
            const player1 = players.find(p => p.id === match.player1Id);
            const player2 = players.find(p => p.id === match.player2Id);
            const result = match.resultValue;
            
            // Проверяем статистику обоих игроков
            [match.player1Id, match.player2Id].forEach(playerId => {
                const stats = playerStats[playerId];
                const player = players.find(p => p.id === playerId);
                
                // Серии побед
                if (stats.currentWinStreak === 10) {
                    addInterestingFact({
                        type: 'win_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: 10,
                        timestamp: new Date().toLocaleString()
                    });
                }
                
                // Серии ничьих
                if (stats.currentDrawStreak === 5) {
                    addInterestingFact({
                        type: 'draw_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: 5,
                        timestamp: new Date().toLocaleString()
                    });
                }
                
                // Серии поражений
                if (stats.currentLossStreak === 10) {
                    addInterestingFact({
                        type: 'loss_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: 10,
                        timestamp: new Date().toLocaleString()
                    });
                }
                
                // Общее количество ничьих
                if (stats.totalDraws === 15) {
                    addInterestingFact({
                        type: 'total_draws',
                        playerId: playerId,
                        playerName: player.name,
                        value: 15,
                        timestamp: new Date().toLocaleString()
                    });
                }
            });
        }
        
        // Добавление интересного факта
        function addInterestingFact(fact) {
            interestingFacts.unshift(fact); // Добавляем в начало массива
            updateFactsDisplay();
            
            // Сохраняем в Firebase
            db.ref('interestingFacts').push(fact);
        }
        
        // Обновление отображения фактов
        function updateFactsDisplay() {
            const container = document.getElementById('factsContainer');
            container.innerHTML = '';
            
            interestingFacts.slice(0, 50).forEach((fact, index) => {
                const card = document.createElement('div');
                card.className = `fact-card ${index < 3 ? 'highlight' : ''}`;
                
                let title = '';
                let content = '';
                
                switch(fact.type) {
                    case 'win_streak':
                        title = 'Серия побед!';
                        content = `<span class="fact-player">${fact.playerName}</span> не знает поражений уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'draw_streak':
                        title = 'Серия ничьих!';
                        content = `<span class="fact-player">${fact.playerName}</span> сыграл вничью уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'loss_streak':
                        title = 'Серия поражений!';
                        content = `<span class="fact-player">${fact.playerName}</span> не может выиграть уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'total_draws':
                        title = 'Рекорд ничьих!';
                        content = `<span class="fact-player">${fact.playerName}</span> достиг отметки в <span class="fact-value">${fact.value}</span> ничьих!`;
                        break;
                }
                
                card.innerHTML = `
                    <div class="fact-title">${title}</div>
                    <div class="fact-content">${content}</div>
                    <div class="fact-date">${fact.timestamp}</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Создание матрицы встреч
        function buildMatrixTable() {
            const table = document.getElementById('matrixTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // Очищаем таблицу
            thead.innerHTML = '<th>Игрок \\ Игрок</th>';
            tbody.innerHTML = '';
            
            // Сортируем игроков по имени
            const sortedPlayers = [...players].sort((a, b) => a.name.localeCompare(b.name));
            
            // Заголовки столбцов
            sortedPlayers.forEach(player => {
                thead.innerHTML += `<th>${player.name}</th>`;
            });
            
            // Заполняем таблицу
            sortedPlayers.forEach(player1 => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${player1.name}</td>`;
                
                sortedPlayers.forEach(player2 => {
                    if (player1.id === player2.id) {
                        row.innerHTML += '<td class="cell-empty">—</td>';
                    } else {
                        // Ищем матчи между этими игроками
                        const matches = history.filter(match => 
                            (match.player1Id === player1.id && match.player2Id === player2.id) ||
                            (match.player1Id === player2.id && match.player2Id === player1.id)
                        );
                        
                        if (matches.length === 0) {
                            row.innerHTML += '<td class="cell-empty"></td>';
                        } else {
                            const lastMatch = matches[matches.length - 1];
                            let resultClass = '';
                            let resultSymbol = '';
                            
                            if (lastMatch.player1Id === player1.id) {
                                // player1 был первым в паре
                                if (lastMatch.resultValue === 1) {
                                    resultClass = 'cell-win';
                                    resultSymbol = 'В';
                                } else if (lastMatch.resultValue === 0) {
                                    resultClass = 'cell-draw';
                                    resultSymbol = 'Н';
                                } else {
                                    resultClass = 'cell-loss';
                                    resultSymbol = 'П';
                                }
                            } else {
                                // player1 был вторым в паре
                                if (lastMatch.resultValue === 2) {
                                    resultClass = 'cell-win';
                                    resultSymbol = 'В';
                                } else if (lastMatch.resultValue === 0) {
                                    resultClass = 'cell-draw';
                                    resultSymbol = 'Н';
                                } else {
                                    resultClass = 'cell-loss';
                                    resultSymbol = 'П';
                                }
                            }
                            
                            row.innerHTML += `<td class="${resultClass}" title="${player1.name} vs ${player2.name} (${lastMatch.timestamp})">${resultSymbol}</td>`;
                        }
                    }
                });
                
                tbody.appendChild(row);
            });
        }
        
        // В функции loadData добавляем загрузку фактов
        db.ref('interestingFacts').on('value', snapshot => {
            const factsData = snapshot.val();
            if (factsData) {
                interestingFacts = Object.values(factsData).sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp));
                updateFactsDisplay();
            }
        });
        
        // В функции switchTab добавляем обработку новых вкладок
        function switchTab(tabId) {
            // ... (предыдущий код)
            
            if (tabId === 'matrix') {
                buildMatrixTable();
            } else if (tabId === 'facts') {
                updateFactsDisplay();
            }
        }
        
        // В функции vote и draw добавляем обновление статистики
        function vote(result) {
            // ... (предыдущий код)
            
            // После сохранения в Firebase:
            updatePlayerStatsAfterMatch(historyEntry);
            buildMatrixTable(); // Обновляем матрицу
        }
        
        function draw() {
            // ... (предыдущий код)
            
            // После сохранения в Firebase:
            updatePlayerStatsAfterMatch(historyEntry);
            buildMatrixTable(); // Обновляем матрицу
        }
        
        // При загрузке данных инициализируем статистику
        db.ref('players').once('value').then(snapshot => {
            // ... (предыдущий код)
            
            initializePlayerStats();
            buildMatrixTable();
        });
    </script>
</body>
</html>