<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Голосование за лучшего футболиста России</title>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #006400;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f0f0f0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #ddd;
        }
        .tab.active {
            background: #006400;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: white;
        }
        .tab-content.active {
            display: block;
        }
        .player-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        .player {
            border: 2px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 280px;
            background: white;
        }
        .player:hover {
            border-color: #006400;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .player img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f0f0f0;
        }
        .player h3 {
            margin: 10px 0;
            color: #333;
        }
        .vs-text {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .buttons {
            text-align: center;
            margin: 30px 0;
        }
        button {
            padding: 12px 25px;
            margin: 0 10px;
            cursor: pointer;
            background: #006400;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background: #004d00;
            transform: translateY(-2px);
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        button.completed {
            background: #4CAF50;
            font-size: 18px;
            padding: 15px 30px;
        }
        .placeholder-img {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* Стили для таблицы результатов */
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 15px;
        }
        #resultsTable th, #resultsTable td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        #resultsTable th {
            background-color: #006400;
            color: white;
            position: sticky;
            top: 0;
        }
        #resultsTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #resultsTable tr:hover {
            background-color: #e6e6e6;
        }
        #resultsTable td:nth-child(6) {
            font-weight: bold;
            color: #006400;
        }
        
        /* Стили для формы последних матчей */
        .form-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin: 0 2px;
            color: white;
            font-weight: bold;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .win {
            background-color: #4CAF50;
        }
        .draw {
            background-color: #FFC107;
        }
        .loss {
            background-color: #F44336;
        }
        .form-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            display: none;
        }
        .form-indicator:hover .form-tooltip {
            display: block;
        }
        .form-container {
            display: flex;
            justify-content: center;
        }
        
        /* Стили для других таблиц */
        #historyTable, #playerStatsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 15px;
        }
        #historyTable th, #historyTable td,
        #playerStatsTable th, #playerStatsTable td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        #historyTable th, #playerStatsTable th {
            background-color: #006400;
            color: white;
        }
        select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin: 10px 0;
            width: 300px;
        }
        .stats-container {
            margin-top: 20px;
        }
        
        /* Новые стили для топ-10 и антитопа */
        .top-players-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .top-players, .bottom-players {
            width: 48%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .top-players h2, .bottom-players h2 {
            color: #006400;
            text-align: center;
            margin-bottom: 15px;
        }
        .player-card {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .player-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 15px;
        }
        .player-info {
            flex-grow: 1;
        }
        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .player-stats {
            display: flex;
            gap: 5px;
        }
        .stat-box {
            display: flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }
        .wins-box {
            background-color: #4CAF50;
        }
        .draws-box {
            background-color: #FFC107;
        }
        .losses-box {
            background-color: #F44336;
        }
        .player-points {
            font-weight: bold;
            color: #006400;
            font-size: 16px;
            min-width: 40px;
            text-align: right;
        }
        .top-player .player-points {
            color: #4CAF50;
        }
        .bottom-player .player-points {
            color: #F44336;
        }
        
        /* Стили для прогресса */
        .progress-container {
            margin: 20px 0;
            background: #f0f0f0;
            border-radius: 5px;
            padding: 10px;
        }
        .progress-bar {
            height: 20px;
            background: #4CAF50;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Кто лучший футболист?</h1>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('voting')">Голосование</div>
        <div class="tab" onclick="switchTab('results')">Результаты</div>
        <div class="tab" onclick="switchTab('history')">История</div>
        <div class="tab" onclick="switchTab('stats')">Статистика</div>
    </div>

    <!-- Вкладка голосования -->
    <div id="voting" class="tab-content active">
        <div class="top-players-container">
            <div class="top-players">
                <h2>Топ-10 игроков</h2>
                <div id="topPlayersList"></div>
            </div>
            <div class="bottom-players">
                <h2>Антитоп (91-100 места)</h2>
                <div id="bottomPlayersList"></div>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText"></div>
        </div>
        
        <div class="player-container">
            <div class="player" id="player1" onclick="vote(1)">
                <div class="placeholder-img" id="player1-placeholder">Фото игрока</div>
                <img src="" alt="" id="player1-img" style="display: none;">
                <h3 id="player1-name">Загрузка...</h3>
            </div>
            <span class="vs-text">vs</span>
            <div class="player" id="player2" onclick="vote(2)">
                <div class="placeholder-img" id="player2-placeholder">Фото игрока</div>
                <img src="" alt="" id="player2-img" style="display: none;">
                <h3 id="player2-name">Загрузка...</h3>
            </div>
        </div>
        <div class="buttons" id="votingButtons">
            <button onclick="vote(1)">Выбрать левого</button>
            <button class="secondary" onclick="draw()">Ничья</button>
            <button onclick="vote(2)">Выбрать правого</button>
        </div>
        <div class="buttons" id="completedButton" style="display: none;">
            <button class="completed">Голосование завершено!</button>
        </div>
    </div>

    <!-- Вкладка результатов -->
    <div id="results" class="tab-content">
        <h2>Таблица результатов</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Игрок</th>
                    <th>В</th>
                    <th>Н</th>
                    <th>П</th>
                    <th>Очки</th>
                    <th>Форма</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Вкладка истории -->
    <div id="history" class="tab-content">
        <h2>История голосований</h2>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Игрок 1</th>
                    <th>Игрок 2</th>
                    <th>Результат</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Вкладка статистики -->
    <div id="stats" class="tab-content">
        <h2>Статистика игрока</h2>
        <select id="playerSelect" onchange="showPlayerStats()">
            <option value="">Выберите игрока</option>
        </select>
        
        <div class="stats-container">
            <h3 id="selectedPlayerName"></h3>
            <table id="playerStatsTable">
                <thead>
                    <tr>
                        <th>Соперник</th>
                        <th>Результат</th>
                        <th>Очки</th>
                    </tr>
                </thead>
                <tbody id="playerStatsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAd2i30miJYAXo0_TreJaBRM2UCiY4B8ds",
            authDomain: "footballvoting-e69aa.firebaseapp.com",
            databaseURL: "https://footballvoting-e69aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "footballvoting-e69aa",
            storageBucket: "footballvoting-e69aa.appspot.com",
            messagingSenderId: "863877355837",
            appId: "1:863877355837:web:0b6f57698eab53ca8d8d54"
        };

        // Инициализация Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized');
        } catch (error) {
            console.error('Firebase error:', error);
        }
        const db = firebase.database();

        // Полный список из 100 игроков
        let players = [
            { id: 1, name: 'Андрей Аршавин', img: 'players/Андрей Аршавин.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 2, name: 'Игорь Акинфеев', img: 'players/Игорь Акинфеев.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 3, name: 'Юрий Жирков', img: 'players/Юрий Жирков.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 4, name: 'Дмитрий Аленичев', img: 'players/Дмитрий Аленичев.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 5, name: 'Сергей Семак', img: 'players/Сергей Семак.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 6, name: 'Алексей Смертин', img: 'players/Алексей Смертин.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 7, name: 'Андрей Канчельскис', img: 'players/Андрей Канчельскис.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 8, name: 'Александр Кержаков', img: 'players/Александр Кержаков.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 9, name: 'Сергей Игнашевич', img: 'players/Сергей Игнашевич.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            { id: 10, name: 'Валерий Карпин', img: 'players/Валерий Карпин.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 },
            // ... (остальные игроки по аналогии) ...
            { id: 100, name: 'Георгий Джикия', img: 'players/Георгий Джикия.jpg?t=' + Date.now(), wins: 0, draws: 0, losses: 0, points: 0, matches: 0 }
        ];

        let currentPair = null;
        let history = [];
        let playedPairs = new Set();
        let availablePlayers = [];
        let totalMatches = 0;
        const totalPossibleMatches = 100 * 99 / 2; // 4950 пар

        // Инициализация данных в Firebase
        function initializeFirebaseData() {
            const initialData = {};
            players.forEach(player => {
                initialData[player.id] = {
                    id: player.id,
                    name: player.name,
                    img: player.img,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0,
                    matches: 0
                };
            });
            return db.ref('players').set(initialData);
        }

        // Загрузка данных
        function loadData() {
            db.ref('players').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && Object.keys(data).length === 100) {
                    players = Object.keys(data).map(key => ({
                        id: Number(key),
                        name: data[key].name,
                        img: data[key].img + '?t=' + Date.now(), // Добавляем timestamp для обхода кэша
                        wins: Number(data[key].wins) || 0,
                        draws: Number(data[key].draws) || 0,
                        losses: Number(data[key].losses) || 0,
                        points: Number(data[key].points) || 0,
                        matches: Number(data[key].matches) || 0
                    }));
                    console.log('Загружено игроков:', players.length);
                } else {
                    console.log('Инициализируем Firebase...');
                    return initializeFirebaseData().then(() => {
                        return db.ref('players').once('value');
                    }).then(snapshot => {
                        const newData = snapshot.val();
                        players = Object.keys(newData).map(key => ({
                            id: Number(key),
                            name: newData[key].name,
                            img: newData[key].img + '?t=' + Date.now(),
                            wins: Number(newData[key].wins) || 0,
                            draws: Number(newData[key].draws) || 0,
                            losses: Number(newData[key].losses) || 0,
                            points: Number(newData[key].points) || 0,
                            matches: Number(newData[key].matches) || 0
                        }));
                    });
                }
            }).then(() => {
                // Загружаем историю для получения сыгранных пар
                return db.ref('history').once('value');
            }).then(snapshot => {
                history = snapshot.val() ? Object.values(snapshot.val()) : [];
                
                // Восстанавливаем сыгранные пары из истории
                playedPairs = new Set();
                history.forEach(match => {
                    const pairKey = getPairKey(match.player1Id, match.player2Id);
                    playedPairs.add(pairKey);
                });
                
                // Обновляем количество матчей для каждого игрока
                players.forEach(player => {
                    player.matches = history.filter(match => 
                        match.player1Id === player.id || match.player2Id === player.id
                    ).length;
                });
                
                totalMatches = playedPairs.size;
                updateProgress();
                updateResults();
                updateTopPlayers();
                initAvailablePlayers();
                getRandomPair();
            }).catch(error => {
                console.error('Ошибка загрузки:', error);
            });

            // Слушаем изменения истории
            db.ref('history').on('value', snapshot => {
                history = snapshot.val() ? Object.values(snapshot.val()) : [];
                updateHistoryTable();
                updatePlayerSelect();
            });
        }

        // Инициализация списка доступных игроков
        function initAvailablePlayers() {
            availablePlayers = players.filter(player => player.matches < 99);
            console.log('Доступно игроков:', availablePlayers.length);
        }

        // Генерация ключа для пары игроков (упорядоченный)
        function getPairKey(id1, id2) {
            return id1 < id2 ? `${id1}-${id2}` : `${id2}-${id1}`;
        }

        // Обновление прогресса голосования
        function updateProgress() {
            const progress = (totalMatches / totalPossibleMatches) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `Сыграно матчей: ${totalMatches} из ${totalPossibleMatches} (${progress.toFixed(1)}%)`;
            
            // Проверяем завершение голосования
            if (totalMatches >= totalPossibleMatches) {
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('completedButton').style.display = 'block';
            }
        }

        // Обновление топ-10 и антитопа
        function updateTopPlayers() {
            const sortedPlayers = [...players].sort((a, b) => b.points - a.points);
            
            // Топ-10 игроков
            const topPlayers = sortedPlayers.slice(0, 10);
            const topPlayersList = document.getElementById('topPlayersList');
            topPlayersList.innerHTML = '';
            
            topPlayers.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card top-player';
                playerCard.innerHTML = `
                    <img src="${player.img}" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" fill=\"%23f0f0f0\"%3E%3Crect width=\"60\" height=\"60\" rx=\"30\" /%3E%3Ctext x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"20\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23888\"%3E${index + 1}%3C/text%3E%3C/svg%3E'">
                    <div class="player-info">
                        <div class="player-name">${index + 1}. ${player.name}</div>
                        <div class="player-stats">
                            <div class="stat-box wins-box">${player.wins}В</div>
                            <div class="stat-box draws-box">${player.draws}Н</div>
                            <div class="stat-box losses-box">${player.losses}П</div>
                        </div>
                    </div>
                    <div class="player-points">${player.points}</div>
                `;
                topPlayersList.appendChild(playerCard);
            });
            
            // Антитоп (91-100 места)
            const bottomPlayers = sortedPlayers.slice(90, 100);
            const bottomPlayersList = document.getElementById('bottomPlayersList');
            bottomPlayersList.innerHTML = '';
            
            bottomPlayers.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card bottom-player';
                playerCard.innerHTML = `
                    <img src="${player.img}" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" fill=\"%23f0f0f0\"%3E%3Crect width=\"60\" height=\"60\" rx=\"30\" /%3E%3Ctext x=\"50%\" y=\"50%\" font-family=\"Arial\" font-size=\"20\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23888\"%3E${index + 91}%3C/text%3E%3C/svg%3E'">
                    <div class="player-info">
                        <div class="player-name">${index + 91}. ${player.name}</div>
                        <div class="player-stats">
                            <div class="stat-box wins-box">${player.wins}В</div>
                            <div class="stat-box draws-box">${player.draws}Н</div>
                            <div class="stat-box losses-box">${player.losses}П</div>
                        </div>
                    </div>
                    <div class="player-points">${player.points}</div>
                `;
                bottomPlayersList.appendChild(playerCard);
            });
        }

        // Голосование
        function vote(result) {
            if (!currentPair) {
                console.error('Текущая пара не установлена');
                return getRandomPair();
            }

            const playerA = players.find(p => p.id === currentPair.a);
            const playerB = players.find(p => p.id === currentPair.b);
            
            if (!playerA || !playerB) {
                console.error('Игроки не найдены');
                return getRandomPair();
            }

            // Обновляем статистику
            if (result === 1) {
                playerA.wins++;
                playerA.points += 3;
                playerB.losses++;
            } else if (result === 2) {
                playerB.wins++;
                playerB.points += 3;
                playerA.losses++;
            }

            // Увеличиваем счетчик матчей
            playerA.matches++;
            playerB.matches++;

            // Добавляем пару в сыгранные
            const pairKey = getPairKey(playerA.id, playerB.id);
            playedPairs.add(pairKey);
            totalMatches++;

            // Подготовка данных для Firebase
            const updates = {
                [`players/${playerA.id}`]: playerA,
                [`players/${playerB.id}`]: playerB
            };

            const historyEntry = {
                player1: playerA.name,
                player2: playerB.name,
                result: result === 1 ? playerA.name : playerB.name,
                timestamp: new Date().toLocaleString(),
                player1Id: playerA.id,
                player2Id: playerB.id,
                resultValue: result
            };

            // Сохраняем с обработкой ошибок
            db.ref().update(updates)
                .then(() => db.ref('history').push(historyEntry))
                .then(() => {
                    updateResults();
                    updateTopPlayers();
                    updateProgress();
                    
                    // Проверяем, нужно ли обновить список доступных игроков
                    if (playerA.matches >= 99 || playerB.matches >= 99) {
                        initAvailablePlayers();
                    }
                    
                    getRandomPair();
                })
                .catch(error => {
                    console.error('Ошибка сохранения:', error);
                    getRandomPair();
                });
        }

        // Ничья
        function draw() {
            if (!currentPair) {
                console.error('Текущая пара не установлена');
                return getRandomPair();
            }

            const playerA = players.find(p => p.id === currentPair.a);
            const playerB = players.find(p => p.id === currentPair.b);
            
            if (!playerA || !playerB) {
                console.error('Игроки не найдены');
                return getRandomPair();
            }

            // Обновляем статистику
            playerA.draws++;
            playerB.draws++;
            playerA.points += 1;
            playerB.points += 1;

            // Увеличиваем счетчик матчей
            playerA.matches++;
            playerB.matches++;

            // Добавляем пару в сыгранные
            const pairKey = getPairKey(playerA.id, playerB.id);
            playedPairs.add(pairKey);
            totalMatches++;

            // Подготовка данных для Firebase
            const updates = {
                [`players/${playerA.id}`]: playerA,
                [`players/${playerB.id}`]: playerB
            };

            const historyEntry = {
                player1: playerA.name,
                player2: playerB.name,
                result: "Ничья",
                timestamp: new Date().toLocaleString(),
                player1Id: playerA.id,
                player2Id: playerB.id,
                resultValue: 0
            };

            // Сохраняем с обработкой ошибок
            db.ref().update(updates)
                .then(() => db.ref('history').push(historyEntry))
                .then(() => {
                    updateResults();
                    updateTopPlayers();
                    updateProgress();
                    
                    // Проверяем, нужно ли обновить список доступных игроков
                    if (playerA.matches >= 99 || playerB.matches >= 99) {
                        initAvailablePlayers();
                    }
                    
                    getRandomPair();
                })
                .catch(error => {
                    console.error('Ошибка сохранения:', error);
                    getRandomPair();
                });
        }

        // Случайная пара игроков
        function getRandomPair() {
            if (totalMatches >= totalPossibleMatches) {
                console.log('Все возможные пары уже сыграли');
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('completedButton').style.display = 'block';
                return;
            }

            if (availablePlayers.length < 2) {
                console.log('Недостаточно доступных игроков');
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('completedButton').style.display = 'block';
                return;
            }

            // Фильтруем игроков, которые еще не сыграли 99 матчей
            const eligiblePlayers = availablePlayers.filter(player => player.matches < 99);
            
            if (eligiblePlayers.length < 2) {
                console.log('Недостаточно игроков с менее чем 99 матчами');
                document.getElementById('votingButtons').style.display = 'none';
                document.getElementById('completedButton').style.display = 'block';
                return;
            }

            let player1, player2;
            let attempts = 0;
            const maxAttempts = 1000;
            
            // Пытаемся найти пару, которая еще не играла
            do {
                const player1Index = Math.floor(Math.random() * eligiblePlayers.length);
                player1 = eligiblePlayers[player1Index];
                
                // Ищем второго игрока, с которым первый еще не играл
                const possibleOpponents = eligiblePlayers.filter(p => 
                    p.id !== player1.id && 
                    !playedPairs.has(getPairKey(player1.id, p.id))
                );
                
                if (possibleOpponents.length > 0) {
                    const player2Index = Math.floor(Math.random() * possibleOpponents.length);
                    player2 = possibleOpponents[player2Index];
                    break;
                }
                
                attempts++;
                if (attempts >= maxAttempts) {
                    console.log('Не удалось найти новую пару после', maxAttempts, 'попыток');
                    document.getElementById('votingButtons').style.display = 'none';
                    document.getElementById('completedButton').style.display = 'block';
                    return;
                }
            } while (true);

            // Обновляем DOM с предзагрузкой изображений
            const img1 = document.getElementById('player1-img');
            const img2 = document.getElementById('player2-img');
            const placeholder1 = document.getElementById('player1-placeholder');
            const placeholder2 = document.getElementById('player2-placeholder');

            // Сначала показываем плейсхолдер
            placeholder1.style.display = 'flex';
            placeholder2.style.display = 'flex';
            img1.style.display = 'none';
            img2.style.display = 'none';

            // Обновляем имена
            document.getElementById('player1-name').textContent = player1.name;
            document.getElementById('player2-name').textContent = player2.name;

            // Предзагрузка изображений с обходом кэша
            const timestamp = Date.now();
            const preloadImg1 = new Image();
            const preloadImg2 = new Image();
            
            preloadImg1.onload = function() {
                img1.src = player1.img.split('?')[0] + '?t=' + timestamp;
                img1.style.display = 'block';
                placeholder1.style.display = 'none';
            };
            preloadImg1.onerror = function() {
                placeholder1.textContent = 'Нет фото';
            };
            
            preloadImg2.onload = function() {
                img2.src = player2.img.split('?')[0] + '?t=' + timestamp;
                img2.style.display = 'block';
                placeholder2.style.display = 'none';
            };
            preloadImg2.onerror = function() {
                placeholder2.textContent = 'Нет фото';
            };
            
            preloadImg1.src = player1.img.split('?')[0] + '?t=' + timestamp;
            preloadImg2.src = player2.img.split('?')[0] + '?t=' + timestamp;

            // Сохраняем текущую пару
            currentPair = { 
                a: Number(player1.id), 
                b: Number(player2.id) 
            };
            
            console.log('Новая пара:', player1.name, 'vs', player2.name);
        }

        // Обновление таблицы результатов
        function updateResults() {
            const sorted = [...players].sort((a, b) => b.points - a.points);
            const tbody = document.querySelector('#resultsTable tbody');
            
            tbody.innerHTML = sorted.map((player, index) => {
                // Получаем последние 5 матчей игрока
                const playerHistory = history.filter(entry => 
                    entry.player1Id === player.id || entry.player2Id === player.id
                ).slice(-5).reverse(); // Берем последние 5 и переворачиваем, чтобы новые были в конце
                
                // Создаем элементы формы
                const formIndicators = playerHistory.map(entry => {
                    const isPlayer1 = entry.player1Id === player.id;
                    let resultClass, resultText, opponent;
                    
                    if (entry.resultValue === 0) {
                        // Ничья
                        resultClass = 'draw';
                        resultText = 'Ничья';
                        opponent = isPlayer1 ? entry.player2 : entry.player1;
                    } else if (isPlayer1) {
                        if (entry.resultValue === 1) {
                            // Победа
                            resultClass = 'win';
                            resultText = 'Победа';
                            opponent = entry.player2;
                        } else {
                            // Поражение
                            resultClass = 'loss';
                            resultText = 'Поражение';
                            opponent = entry.player2;
                        }
                    } else {
                        if (entry.resultValue === 2) {
                            // Победа
                            resultClass = 'win';
                            resultText = 'Победа';
                            opponent = entry.player1;
                        } else {
                            // Поражение
                            resultClass = 'loss';
                            resultText = 'Поражение';
                            opponent = entry.player1;
                        }
                    }
                    
                    return `
                        <div class="form-indicator ${resultClass}">
                            ${entry.resultValue === 0 ? 'Н' : (resultClass === 'win' ? 'В' : 'П')}
                            <div class="form-tooltip">
                                ${opponent}: ${resultText}<br>
                                ${entry.timestamp}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.wins}</td>
                        <td>${player.draws}</td>
                        <td>${player.losses}</td>
                        <td>${player.points}</td>
                        <td>
                            <div class="form-container">
                                ${playerHistory.length > 0 ? formIndicators : 'Нет данных'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Обновление таблицы истории
        function updateHistoryTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = history.map(entry => `
                <tr>
                    <td>${entry.timestamp}</td>
                    <td>${entry.player1}</td>
                    <td>${entry.player2}</td>
                    <td>${entry.result}</td>
                </tr>
            `).reverse().join('');
        }

        // Обновление списка игроков для статистики
        function updatePlayerSelect() {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">Выберите игрока</option>' + 
                players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // Показать статистику игрока
        function showPlayerStats() {
            const playerId = parseInt(document.getElementById('playerSelect').value);
            if (!playerId) return;

            const player = players.find(p => p.id === playerId);
            if (!player) return;

            document.getElementById('selectedPlayerName').textContent = `${player.name} (${player.points} очков, ${player.matches} матчей)`;

            const playerHistory = history.filter(entry => 
                entry.player1Id === playerId || entry.player2Id === playerId
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tbody = document.getElementById('playerStatsBody');
            tbody.innerHTML = playerHistory.map(entry => {
                const isPlayer1 = entry.player1Id === playerId;
                const opponent = isPlayer1 ? entry.player2 : entry.player1;
                let result, points;
                
                if (entry.resultValue === 0) {
                    result = "Ничья";
                    points = 1;
                } else if (isPlayer1) {
                    result = entry.resultValue === 1 ? "Победа" : "Поражение";
                    points = entry.resultValue === 1 ? 3 : 0;
                } else {
                    result = entry.resultValue === 2 ? "Победа" : "Поражение";
                    points = entry.resultValue === 2 ? 3 : 0;
                }

                return `
                    <tr>
                        <td>${opponent}</td>
                        <td>${result}</td>
                        <td>${points}</td>
                    </tr>
                `;
            }).join('');
        }

        // Переключение вкладок
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabId)) {
                    tab.classList.add('active');
                }
            });

            if (tabId === 'stats') {
                updatePlayerSelect();
            } else if (tabId === 'results') {
                updateResults();
                updateTopPlayers();
            }
        }

        // Запуск при загрузке страницы
        window.onload = () => {
            console.log('Страница загружена');
            loadData();
        };
    </script>
</body>
</html>