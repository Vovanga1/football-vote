<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Голосование за лучшего футболиста России</title>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #006400;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f0f0f0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
            margin-bottom: 5px;
        }
        .tab:hover {
            background: #ddd;
        }
        .tab.active {
            background: #006400;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: white;
        }
        .tab-content.active {
            display: block;
        }
        .player-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        .player {
            border: 2px solid #ccc;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 280px;
            background: white;
        }
        .player:hover {
            border-color: #006400;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .player img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f0f0f0;
        }
        .player h3 {
            margin: 10px 0;
            color: #333;
        }
        .vs-text {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .buttons {
            text-align: center;
            margin: 30px 0;
        }
        button {
            padding: 12px 25px;
            margin: 0 10px;
            cursor: pointer;
            background: #006400;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background: #004d00;
            transform: translateY(-2px);
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        .placeholder-img {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* Стили для таблицы результатов */
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 15px;
        }
        #resultsTable th, #resultsTable td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        #resultsTable th {
            background-color: #006400;
            color: white;
            position: sticky;
            top: 0;
        }
        #resultsTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #resultsTable tr:hover {
            background-color: #e6e6e6;
        }
        #resultsTable td:nth-child(6) {
            font-weight: bold;
            color: #006400;
        }
        
        /* Стили для формы последних матчей */
        .form-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin: 0 2px;
            color: white;
            font-weight: bold;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .win {
            background-color: #4CAF50;
        }
        .draw {
            background-color: #FFC107;
        }
        .loss {
            background-color: #F44336;
        }
        .form-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            display: none;
        }
        .form-indicator:hover .form-tooltip {
            display: block;
        }
        .form-container {
            display: flex;
            justify-content: center;
        }
        
        /* Стили для шахматной таблицы */
        .matrix-container {
            overflow: auto;
            max-height: 80vh;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        #matrixTable {
            border-collapse: collapse;
            font-size: 14px;
            min-width: 100%;
        }
        
        #matrixTable th, #matrixTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 40px;
            height: 40px;
        }
        
        #matrixTable th {
            position: sticky;
            top: 0;
            background: #006400;
            color: white;
            z-index: 10;
        }
        
        #matrixTable th:first-child {
            left: 0;
            z-index: 20;
        }
        
        #matrixTable td:first-child {
            position: sticky;
            left: 0;
            background: white;
            font-weight: bold;
            z-index: 5;
        }
        
        .cell-win {
            background-color: #4CAF50;
            color: white;
        }
        
        .cell-draw {
            background-color: #FFC107;
        }
        
        .cell-loss {
            background-color: #F44336;
            color: white;
        }
        
        .cell-empty {
            background-color: #f9f9f9;
        }
        
        /* Стили для вкладки интересных фактов */
        .facts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .fact-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #006400;
        }
        
        .fact-card.highlight {
            border-left-color: #FFC107;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,193,7,0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255,193,7,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,193,7,0); }
        }
        
        .fact-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #006400;
        }
        
        .fact-player {
            font-weight: bold;
            color: #006400;
        }
        
        .fact-value {
            font-weight: bold;
            color: #F44336;
        }
        
        .fact-date {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        /* Стили для других таблиц */
        #historyTable, #playerStatsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 15px;
        }
        #historyTable th, #historyTable td,
        #playerStatsTable th, #playerStatsTable td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        #historyTable th, #playerStatsTable th {
            background-color: #006400;
            color: white;
        }
        select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin: 10px 0;
            width: 300px;
        }
        .stats-container {
            margin-top: 20px;
        }
        
        /* Адаптивные стили */
        @media (max-width: 768px) {
            .player {
                width: 100%;
                max-width: 280px;
            }
            
            .buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
                margin: 5px 0;
            }
            
            .facts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Кто лучший футболист?</h1>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('voting')">Голосование</div>
        <div class="tab" onclick="switchTab('results')">Результаты</div>
        <div class="tab" onclick="switchTab('matrix')">Матрица встреч</div>
        <div class="tab" onclick="switchTab('facts')">Интересные факты</div>
        <div class="tab" onclick="switchTab('history')">История</div>
        <div class="tab" onclick="switchTab('stats')">Статистика</div>
    </div>

    <!-- Вкладка голосования -->
    <div id="voting" class="tab-content active">
        <div class="player-container">
            <div class="player" id="player1" onclick="vote(1)">
                <div class="placeholder-img" id="player1-placeholder">Фото игрока</div>
                <img src="" alt="" id="player1-img" style="display: none;">
                <h3 id="player1-name">Загрузка...</h3>
            </div>
            <span class="vs-text">vs</span>
            <div class="player" id="player2" onclick="vote(2)">
                <div class="placeholder-img" id="player2-placeholder">Фото игрока</div>
                <img src="" alt="" id="player2-img" style="display: none;">
                <h3 id="player2-name">Загрузка...</h3>
            </div>
        </div>
        <div class="buttons">
            <button onclick="vote(1)">Выбрать левого</button>
            <button class="secondary" onclick="draw()">Ничья</button>
            <button onclick="vote(2)">Выбрать правого</button>
        </div>
    </div>

    <!-- Вкладка результатов -->
    <div id="results" class="tab-content">
        <h2>Таблица результатов</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Игрок</th>
                    <th>В</th>
                    <th>Н</th>
                    <th>П</th>
                    <th>Очки</th>
                    <th>Форма</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Вкладка матрицы встреч -->
    <div id="matrix" class="tab-content">
        <h2>Матрица встреч</h2>
        <p>Показаны результаты последних встреч между игроками</p>
        <div class="matrix-container">
            <table id="matrixTable">
                <thead>
                    <tr>
                        <th>Игрок \ Игрок</th>
                        <!-- Заголовки будут заполнены скриптом -->
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Вкладка интересных фактов -->
    <div id="facts" class="tab-content">
        <h2>Интересные факты</h2>
        <p>Автоматически обнаруживаемые достижения и статистические рекорды</p>
        <div class="facts-container" id="factsContainer">
            <!-- Факты будут добавляться динамически -->
        </div>
    </div>

    <!-- Вкладка истории -->
    <div id="history" class="tab-content">
        <h2>История голосований</h2>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Игрок 1</th>
                    <th>Игрок 2</th>
                    <th>Результат</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Вкладка статистики -->
    <div id="stats" class="tab-content">
        <h2>Статистика игрока</h2>
        <select id="playerSelect" onchange="showPlayerStats()">
            <option value="">Выберите игрока</option>
        </select>
        
        <div class="stats-container">
            <h3 id="selectedPlayerName"></h3>
            <table id="playerStatsTable">
                <thead>
                    <tr>
                        <th>Соперник</th>
                        <th>Результат</th>
                        <th>Очки</th>
                    </tr>
                </thead>
                <tbody id="playerStatsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Запуск при загрузке страницы
        window.onload = () => {
            console.log('Страница загружена');
            loadData();
        };

        // Переключение вкладок
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabId)) {
                    tab.classList.add('active');
                }
            });

            if (tabId === 'stats') {
                updatePlayerSelect();
            } else if (tabId === 'results') {
                updateResults();
            } else if (tabId === 'matrix') {
                buildMatrixTable();
            } else if (tabId === 'facts') {
                updateFactsDisplay();
            }
        }

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAd2i30miJYAXo0_TreJaBRM2UCiY4B8ds",
            authDomain: "footballvoting-e69aa.firebaseapp.com",
            databaseURL: "https://footballvoting-e69aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "footballvoting-e69aa",
            storageBucket: "footballvoting-e69aa.appspot.com",
            messagingSenderId: "863877355837",
            appId: "1:863877355837:web:0b6f57698eab53ca8d8d54"
        };

        // Инициализация Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized');
        } catch (error) {
            console.error('Firebase error:', error);
        }
        const db = firebase.database();

        // Полный список из 100 игроков
        let players = [
            { id: 1, name: 'Андрей Аршавин', img: 'players/Андрей Аршавин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 2, name: 'Игорь Акинфеев', img: 'players/Игорь Акинфеев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 3, name: 'Юрий Жирков', img: 'players/Юрий Жирков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 4, name: 'Дмитрий Аленичев', img: 'players/Дмитрий Аленичев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 5, name: 'Сергей Семак', img: 'players/Сергей Семак.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 6, name: 'Алексей Смертин', img: 'players/Алексей Смертин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 7, name: 'Андрей Канчельскис', img: 'players/Андрей Канчельскис.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 8, name: 'Александр Кержаков', img: 'players/Александр Кержаков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 9, name: 'Сергей Игнашевич', img: 'players/Сергей Игнашевич.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 10, name: 'Валерий Карпин', img: 'players/Валерий Карпин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 11, name: 'Дмитрий Лоськов', img: 'players/Дмитрий Лоськов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 12, name: 'Роман Павлюченко', img: 'players/Роман Павлюченко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 13, name: 'Андрей Тихонов', img: 'players/Андрей Тихонов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 14, name: 'Василий Березуцкий', img: 'players/Василий Березуцкий.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 15, name: 'Александр Головин', img: 'players/Александр Головин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 16, name: 'Павел Погребняк', img: 'players/Павел Погребняк.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 17, name: 'Сергей Овчинников', img: 'players/Сергей Овчинников.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 18, name: 'Константин Зырянов', img: 'players/Константин Зырянов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 19, name: 'Вячеслав Малафеев', img: 'players/Вячеслав Малафеев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 20, name: 'Виктор Онопко', img: 'players/Виктор Онопко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 21, name: 'Владимир Бесчастных', img: 'players/Владимир Бесчастных.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 22, name: 'Денис Черышев', img: 'players/Денис Черышев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 23, name: 'Игорь Денисов', img: 'players/Игорь Денисов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 24, name: 'Егор Титов', img: 'players/Егор Титов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 25, name: 'Алексей Миранчук', img: 'players/Алексей Миранчук.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 26, name: 'Дмитрий Сычев', img: 'players/Дмитрий Сычев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 27, name: 'Олег Веретенников', img: 'players/Олег Веретенников.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 28, name: 'Ролан Гусев', img: 'players/Ролан Гусев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 29, name: 'Артём Дзюба', img: 'players/Артём Дзюба.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 30, name: 'Денис Колодин', img: 'players/Денис Колодин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 31, name: 'Александр Мостовой', img: 'players/Александр Мостовой.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 32, name: 'Динияр Билялетдинов', img: 'players/Динияр Билялетдинов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 33, name: 'Александр Анюков', img: 'players/Александр Анюков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 34, name: 'Марат Измайлов', img: 'players/Марат Измайлов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 35, name: 'Дмитрий Булыкин', img: 'players/Дмитрий Булыкин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 36, name: 'Матвей Сафонов', img: 'players/Матвей Сафонов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 37, name: 'Олег Саленко', img: 'players/Олег Саленко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 38, name: 'Гильерме', img: 'players/Гильерме.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 39, name: 'Владимир Быстров', img: 'players/Владимир Быстров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 40, name: 'Алан Дзагоев', img: 'players/Алан Дзагоев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 41, name: 'Илья Цымбаларь', img: 'players/Илья Цымбаларь.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 42, name: 'Роман Широков', img: 'players/Роман Широков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 43, name: 'Вадим Евсеев', img: 'players/Вадим Евсеев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 44, name: 'Алексей Березуцкий', img: 'players/Алексей Березуцкий.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 45, name: 'Дмитрий Хохлов', img: 'players/Дмитрий Хохлов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 46, name: 'Игорь Шалимов', img: 'players/Игорь Шалимов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 47, name: 'Дмитрий Харин', img: 'players/Дмитрий Харин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 48, name: 'Дмитрий Ананко', img: 'players/Дмитрий Ананко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 49, name: 'Фёдор Черенков', img: 'players/Фёдор Черенков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 50, name: 'Дмитрий Кириченко', img: 'players/Дмитрий Кириченко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 51, name: 'Руслан Нигматуллин', img: 'players/Руслан Нигматуллин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 52, name: 'Сергей Рыжиков', img: 'players/Сергей Рыжиков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 53, name: 'Дмитрий Сенников', img: 'players/Дмитрий Сенников.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 54, name: 'Георгий Щенников', img: 'players/Георгий Щенников.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 55, name: 'Александр Ерохин', img: 'players/Александр Ерохин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 56, name: 'Денис Бояринцев', img: 'players/Денис Бояринцев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 57, name: 'Владислав Радимов', img: 'players/Владислав Радимов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 58, name: 'Игорь Семшов', img: 'players/Игорь Семшов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 59, name: 'Игорь Колыванов', img: 'players/Игорь Колыванов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 60, name: 'Далер Кузяев', img: 'players/Далер Кузяев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 61, name: 'Денис Глушаков', img: 'players/Денис Глушаков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 62, name: 'Дмитрий Баринов', img: 'players/Дмитрий Баринов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 63, name: 'Андрей Лунёв', img: 'players/Андрей Лунёв.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 64, name: 'Александр Бухаров', img: 'players/Александр Бухаров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 65, name: 'Геннадий Нижегородов', img: 'players/Геннадий Нижегородов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 66, name: 'Игорь Корнеев', img: 'players/Игорь Корнеев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 67, name: 'Роман Зобнин', img: 'players/Роман Зобнин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 68, name: 'Александр Кокорин', img: 'players/Александр Кокорин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 69, name: 'Юрий Дроздов', img: 'players/Юрий Дроздов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 70, name: 'Александр Ширко', img: 'players/Александр Ширко.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 71, name: 'Дмитрий Комбаров', img: 'players/Дмитрий Комбаров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 72, name: 'Владимир Бут', img: 'players/Владимир Бут.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 73, name: 'Владимир Кульков', img: 'players/Владимир Кульков.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 74, name: 'Марио Фернандес', img: 'players/Марио Фернандес.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 75, name: 'Евгений Алдонин', img: 'players/Евгений Алдонин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 76, name: 'Антон Шунин', img: 'players/Антон Шунин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 77, name: 'Станислав Черчесов', img: 'players/Станислав Черчесов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 78, name: 'Виктор Файзулин', img: 'players/Виктор Файзулин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 79, name: 'Игорь Яновский', img: 'players/Игорь Яновский.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 80, name: 'Руслан Пименов', img: 'players/Руслан Пименов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 81, name: 'Валерий Минько', img: 'players/Валерий Минько.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 82, name: 'Пётр Быстров', img: 'players/Пётр Быстров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 83, name: 'Александр Панов', img: 'players/Александр Панов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 84, name: 'Сергей Юран', img: 'players/Сергей Юран.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 85, name: 'Александр Самедов', img: 'players/Александр Самедов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 86, name: 'Андрей Каряка', img: 'players/Андрей Каряка.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 87, name: 'Александр Рязанцев', img: 'players/Александр Рязанцев.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 88, name: 'Игорь Смольников', img: 'players/Игорь Смольников.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 89, name: 'Игорь Добровольский', img: 'players/Игорь Добровольский.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 90, name: 'Артём Ребров', img: 'players/Артём Ребров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 91, name: 'Ари', img: 'players/Ари.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 92, name: 'Юрий Никифоров', img: 'players/Юрий Никифоров.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 93, name: 'Валерий Есипов', img: 'players/Валерий Есипов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 94, name: 'Кирилл Набабкин', img: 'players/Кирилл Набабкин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 95, name: 'Максим Бузникин', img: 'players/Максим Бузникин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 96, name: 'Александр Филимонов', img: 'players/Александр Филимонов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 97, name: 'Роман Шаронов', img: 'players/Роман Шаронов.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 98, name: 'Александр Точилин', img: 'players/Александр Точилин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 99, name: 'Дмитрий Бородин', img: 'players/Дмитрий Бородин.jpg', wins: 0, draws: 0, losses: 0, points: 0 },
            { id: 100, name: 'Георгий Джикия', img: 'players/Георгий Джикия.jpg', wins: 0, draws: 0, losses: 0, points: 0 }
        ];

        let currentPair = null;
        let history = [];
        let playerStats = {};
        let interestingFacts = [];

        // Инициализация Firebase данных
        function initializeFirebaseData() {
            const initialData = {};
            players.forEach(player => {
                initialData[player.id] = {
                    id: player.id,
                    name: player.name,
                    img: player.img,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0
                };
                
                playerStats[player.id] = {
                    currentWinStreak: 0,
                    currentDrawStreak: 0,
                    currentLossStreak: 0,
                    maxWinStreak: 0,
                    maxDrawStreak: 0,
                    maxLossStreak: 0,
                    totalWins: 0,
                    totalDraws: 0,
                    totalLosses: 0,
                    lastMatches: []
                };
            });
            return db.ref('players').set(initialData);
        }

        // Загрузка данных
        function loadData() {
            db.ref('players').once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && Object.keys(data).length === 100) {
                    players = Object.keys(data).map(key => ({
                        id: Number(key),
                        name: data[key].name,
                        img: data[key].img,
                        wins: Number(data[key].wins) || 0,
                        draws: Number(data[key].draws) || 0,
                        losses: Number(data[key].losses) || 0,
                        points: Number(data[key].points) || 0
                    }));
                } else {
                    return initializeFirebaseData().then(() => db.ref('players').once('value'))
                        .then(snapshot => {
                            const newData = snapshot.val();
                            players = Object.keys(newData).map(key => ({
                                id: Number(key),
                                name: newData[key].name,
                                img: newData[key].img,
                                wins: Number(newData[key].wins) || 0,
                                draws: Number(newData[key].draws) || 0,
                                losses: Number(newData[key].losses) || 0,
                                points: Number(newData[key].points) || 0
                            }));
                        });
                }
            }).then(() => {
                initializePlayerStats();
                updateResults();
                getRandomPair();
                buildMatrixTable();
            }).catch(error => {
                console.error('Ошибка загрузки:', error);
            });

            // Загрузка истории
            db.ref('history').on('value', snapshot => {
                history = snapshot.val() ? Object.values(snapshot.val()) : [];
                updateHistoryTable();
                updatePlayerSelect();
                updateResults();
                buildMatrixTable();
            });

            // Загрузка интересных фактов
            db.ref('interestingFacts').on('value', snapshot => {
                const factsData = snapshot.val();
                if (factsData) {
                    interestingFacts = Object.values(factsData).sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp));
                    updateFactsDisplay();
                }
            });
        }

        // Инициализация статистики игроков
        function initializePlayerStats() {
            players.forEach(player => {
                playerStats[player.id] = {
                    currentWinStreak: 0,
                    currentDrawStreak: 0,
                    currentLossStreak: 0,
                    maxWinStreak: 0,
                    maxDrawStreak: 0,
                    maxLossStreak: 0,
                    totalWins: 0,
                    totalDraws: 0,
                    totalLosses: 0,
                    lastMatches: []
                };
            });

            history.forEach(match => {
                updatePlayerStatsAfterMatch(match);
            });
        }

        // Обновление статистики после матча
        function updatePlayerStatsAfterMatch(match) {
            const player1Id = match.player1Id;
            const player2Id = match.player2Id;
            const result = match.resultValue;
            
            updatePlayerStatsSingle(player1Id, result === 1 ? 'win' : (result === 0 ? 'draw' : 'loss'));
            updatePlayerStatsSingle(player2Id, result === 2 ? 'win' : (result === 0 ? 'draw' : 'loss'));
            
            checkForInterestingFacts(match);
        }

        // Обновление статистики одного игрока
        function updatePlayerStatsSingle(playerId, result) {
            const stats = playerStats[playerId];
            
            if (result !== 'win') stats.currentWinStreak = 0;
            if (result !== 'draw') stats.currentDrawStreak = 0;
            if (result !== 'loss') stats.currentLossStreak = 0;
            
            if (result === 'win') {
                stats.currentWinStreak++;
                stats.totalWins++;
                if (stats.currentWinStreak > stats.maxWinStreak) {
                    stats.maxWinStreak = stats.currentWinStreak;
                }
            } else if (result === 'draw') {
                stats.currentDrawStreak++;
                stats.totalDraws++;
                if (stats.currentDrawStreak > stats.maxDrawStreak) {
                    stats.maxDrawStreak = stats.currentDrawStreak;
                }
            } else {
                stats.currentLossStreak++;
                stats.totalLosses++;
                if (stats.currentLossStreak > stats.maxLossStreak) {
                    stats.maxLossStreak = stats.currentLossStreak;
                }
            }
            
            // Обновляем последние матчи (максимум 5)
            if (stats.lastMatches.length >= 5) {
                stats.lastMatches.pop();
            }
            stats.lastMatches.unshift({
                result: result,
                timestamp: new Date().toISOString()
            });
        }

        // Проверка на интересные факты
        function checkForInterestingFacts(match) {
            [match.player1Id, match.player2Id].forEach(playerId => {
                const stats = playerStats[playerId];
                const player = players.find(p => p.id === playerId);
                
                // Серии побед
                if (stats.currentWinStreak === 5 || stats.currentWinStreak === 10) {
                    addInterestingFact({
                        type: 'win_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.currentWinStreak,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Серии ничьих
                if (stats.currentDrawStreak === 3 || stats.currentDrawStreak === 5) {
                    addInterestingFact({
                        type: 'draw_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.currentDrawStreak,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Серии поражений
                if (stats.currentLossStreak === 5 || stats.currentLossStreak === 10) {
                    addInterestingFact({
                        type: 'loss_streak',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.currentLossStreak,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Общее количество ничьих
                if (stats.totalDraws === 10 || stats.totalDraws === 20) {
                    addInterestingFact({
                        type: 'total_draws',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.totalDraws,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Общее количество побед
                if (stats.totalWins === 25 || stats.totalWins === 50) {
                    addInterestingFact({
                        type: 'total_wins',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.totalWins,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Общее количество поражений
                if (stats.totalLosses === 25 || stats.totalLosses === 50) {
                    addInterestingFact({
                        type: 'total_losses',
                        playerId: playerId,
                        playerName: player.name,
                        value: stats.totalLosses,
                        timestamp: new Date().toISOString()
                    });
                }
            });
        }

        // Добавление интересного факта
        function addInterestingFact(fact) {
            interestingFacts.unshift(fact);
            updateFactsDisplay();
            db.ref('interestingFacts').push(fact);
        }

        // Обновление отображения фактов
        function updateFactsDisplay() {
            const container = document.getElementById('factsContainer');
            container.innerHTML = '';
            
            interestingFacts.slice(0, 50).forEach((fact, index) => {
                const card = document.createElement('div');
                card.className = `fact-card ${index < 3 ? 'highlight' : ''}`;
                
                let title = '';
                let content = '';
                
                switch(fact.type) {
                    case 'win_streak':
                        title = 'Серия побед!';
                        content = `<span class="fact-player">${fact.playerName}</span> не знает поражений уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'draw_streak':
                        title = 'Серия ничьих!';
                        content = `<span class="fact-player">${fact.playerName}</span> сыграл вничью уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'loss_streak':
                        title = 'Серия поражений!';
                        content = `<span class="fact-player">${fact.playerName}</span> не может выиграть уже <span class="fact-value">${fact.value}</span> матчей подряд!`;
                        break;
                    case 'total_draws':
                        title = 'Рекорд ничьих!';
                        content = `<span class="fact-player">${fact.playerName}</span> достиг отметки в <span class="fact-value">${fact.value}</span> ничьих!`;
                        break;
                    case 'total_wins':
                        title = 'Рекорд побед!';
                        content = `<span class="fact-player">${fact.playerName}</span> одержал <span class="fact-value">${fact.value}</span> побед!`;
                        break;
                    case 'total_losses':
                        title = 'Рекорд поражений!';
                        content = `<span class="fact-player">${fact.playerName}</span> потерпел <span class="fact-value">${fact.value}</span> поражений!`;
                        break;
                }
                
                card.innerHTML = `
                    <div class="fact-title">${title}</div>
                    <div class="fact-content">${content}</div>
                    <div class="fact-date">${new Date(fact.timestamp).toLocaleString()}</div>
                `;
                
                container.appendChild(card);
            });
        }

        // Построение матрицы встреч
        function buildMatrixTable() {
            const table = document.getElementById('matrixTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            thead.innerHTML = '<th>Игрок \\ Игрок</th>';
            tbody.innerHTML = '';
            
            // Сортируем игроков по очкам (от большего к меньшему)
            const sortedPlayers = [...players].sort((a, b) => b.points - a.points);
            
            // Добавляем заголовки с именами игроков
            sortedPlayers.forEach(player => {
                thead.innerHTML += `<th title="${player.name}">${player.name.split(' ')[1] || player.name}</th>`;
            });
            
            // Заполняем строки матрицы
            sortedPlayers.forEach(player1 => {
                const row = document.createElement('tr');
                row.innerHTML = `<td title="${player1.name}">${player1.name.split(' ')[1] || player1.name}</td>`;
                
                sortedPlayers.forEach(player2 => {
                    if (player1.id === player2.id) {
                        row.innerHTML += '<td class="cell-empty">—</td>';
                    } else {
                        const matches = history.filter(match => 
                            (match.player1Id === player1.id && match.player2Id === player2.id) ||
                            (match.player1Id === player2.id && match.player2Id === player1.id)
                        );
                        
                        if (matches.length === 0) {
                            row.innerHTML += '<td class="cell-empty"></td>';
                        } else {
                            const lastMatch = matches[matches.length - 1];
                            let resultClass = '';
                            let resultSymbol = '';
                            
                            if (lastMatch.player1Id === player1.id) {
                                if (lastMatch.resultValue === 1) {
                                    resultClass = 'cell-win';
                                    resultSymbol = 'В';
                                } else if (lastMatch.resultValue === 0) {
                                    resultClass = 'cell-draw';
                                    resultSymbol = 'Н';
                                } else {
                                    resultClass = 'cell-loss';
                                    resultSymbol = 'П';
                                }
                            } else {
                                if (lastMatch.resultValue === 2) {
                                    resultClass = 'cell-win';
                                    resultSymbol = 'В';
                                } else if (lastMatch.resultValue === 0) {
                                    resultClass = 'cell-draw';
                                    resultSymbol = 'Н';
                                } else {
                                    resultClass = 'cell-loss';
                                    resultSymbol = 'П';
                                }
                            }
                            
                            row.innerHTML += `<td class="${resultClass}" title="${player1.name} vs ${player2.name} (${lastMatch.timestamp})">${resultSymbol}</td>`;
                        }
                    }
                });
                
                tbody.appendChild(row);
            });
        }

        // Голосование
        function vote(result) {
            if (!currentPair) return getRandomPair();

            const playerA = players.find(p => p.id === currentPair.a);
            const playerB = players.find(p => p.id === currentPair.b);
            
            if (!playerA || !playerB) return getRandomPair();

            if (result === 1) {
                playerA.wins++;
                playerA.points += 3;
                playerB.losses++;
            } else if (result === 2) {
                playerB.wins++;
                playerB.points += 3;
                playerA.losses++;
            }

            const updates = {
                [`players/${playerA.id}`]: playerA,
                [`players/${playerB.id}`]: playerB
            };

            const historyEntry = {
                player1: playerA.name,
                player2: playerB.name,
                result: result === 1 ? playerA.name : playerB.name,
                timestamp: new Date().toISOString(),
                player1Id: playerA.id,
                player2Id: playerB.id,
                resultValue: result
            };

            db.ref().update(updates)
                .then(() => db.ref('history').push(historyEntry))
                .then(() => {
                    updatePlayerStatsAfterMatch(historyEntry);
                    updateResults();
                    getRandomPair();
                    buildMatrixTable();
                })
                .catch(error => {
                    console.error('Ошибка сохранения:', error);
                    getRandomPair();
                });
        }

        // Ничья
        function draw() {
            if (!currentPair) return getRandomPair();

            const playerA = players.find(p => p.id === currentPair.a);
            const playerB = players.find(p => p.id === currentPair.b);
            
            if (!playerA || !playerB) return getRandomPair();

            playerA.draws++;
            playerB.draws++;
            playerA.points += 1;
            playerB.points += 1;

            const updates = {
                [`players/${playerA.id}`]: playerA,
                [`players/${playerB.id}`]: playerB
            };

            const historyEntry = {
                player1: playerA.name,
                player2: playerB.name,
                result: "Ничья",
                timestamp: new Date().toISOString(),
                player1Id: playerA.id,
                player2Id: playerB.id,
                resultValue: 0
            };

            db.ref().update(updates)
                .then(() => db.ref('history').push(historyEntry))
                .then(() => {
                    updatePlayerStatsAfterMatch(historyEntry);
                    updateResults();
                    getRandomPair();
                    buildMatrixTable();
                })
                .catch(error => {
                    console.error('Ошибка сохранения:', error);
                    getRandomPair();
                });
        }

        // Получение случайной пары игроков
        function getRandomPair() {
            if (!players || players.length < 2) return;

            // Учитываем рейтинг при выборе пары (более сильные игроки встречаются чаще)
            const weightedPlayers = [];
            players.forEach(player => {
                const weight = Math.max(1, Math.sqrt(player.points + 1));
                for (let i = 0; i < weight; i++) {
                    weightedPlayers.push(player.id);
                }
            });

            const player1Id = weightedPlayers[Math.floor(Math.random() * weightedPlayers.length)];
            let player2Id;
            
            do {
                player2Id = weightedPlayers[Math.floor(Math.random() * weightedPlayers.length)];
            } while (player2Id === player1Id);

            const player1 = players.find(p => p.id === player1Id);
            const player2 = players.find(p => p.id === player2Id);

            const img1 = document.getElementById('player1-img');
            const img2 = document.getElementById('player2-img');
            const placeholder1 = document.getElementById('player1-placeholder');
            const placeholder2 = document.getElementById('player2-placeholder');

            placeholder1.style.display = 'flex';
            placeholder2.style.display = 'flex';
            img1.style.display = 'none';
            img2.style.display = 'none';

            document.getElementById('player1-name').textContent = player1.name;
            document.getElementById('player2-name').textContent = player2.name;

            const preloadImg1 = new Image();
            const preloadImg2 = new Image();
            
            preloadImg1.onload = function() {
                img1.src = player1.img;
                img1.style.display = 'block';
                placeholder1.style.display = 'none';
            };
            preloadImg1.onerror = function() {
                placeholder1.textContent = 'Нет фото';
            };
            
            preloadImg2.onload = function() {
                img2.src = player2.img;
                img2.style.display = 'block';
                placeholder2.style.display = 'none';
            };
            preloadImg2.onerror = function() {
                placeholder2.textContent = 'Нет фото';
            };
            
            preloadImg1.src = player1.img;
            preloadImg2.src = player2.img;

            currentPair = { 
                a: Number(player1.id), 
                b: Number(player2.id) 
            };
        }

        // Обновление таблицы результатов
        function updateResults() {
            const sorted = [...players].sort((a, b) => b.points - a.points);
            const tbody = document.querySelector('#resultsTable tbody');
            
            tbody.innerHTML = sorted.map((player, index) => {
                const stats = playerStats[player.id] || {};
                const formIndicators = (stats.lastMatches || []).map(match => {
                    let resultClass, resultSymbol;
                    
                    if (match.result === 'win') {
                        resultClass = 'win';
                        resultSymbol = 'В';
                    } else if (match.result === 'draw') {
                        resultClass = 'draw';
                        resultSymbol = 'Н';
                    } else {
                        resultClass = 'loss';
                        resultSymbol = 'П';
                    }
                    
                    return `
                        <div class="form-indicator ${resultClass}" title="${new Date(match.timestamp).toLocaleString()}">
                            ${resultSymbol}
                        </div>
                    `;
                }).join('');
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.wins}</td>
                        <td>${player.draws}</td>
                        <td>${player.losses}</td>
                        <td>${player.points}</td>
                        <td>
                            <div class="form-container">
                                ${formIndicators || 'Нет данных'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Обновление таблицы истории
        function updateHistoryTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = history.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.player1}</td>
                    <td>${entry.player2}</td>
                    <td>${entry.result}</td>
                </tr>
            `).reverse().join('');
        }

        // Обновление списка игроков для статистики
        function updatePlayerSelect() {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">Выберите игрока</option>' + 
                players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // Показать статистику игрока
        function showPlayerStats() {
            const playerId = parseInt(document.getElementById('playerSelect').value);
            if (!playerId) return;

            const player = players.find(p => p.id === playerId);
            if (!player) return;

            document.getElementById('selectedPlayerName').textContent = `${player.name} (${player.points} очков)`;

            const playerHistory = history.filter(entry => 
                entry.player1Id === playerId || entry.player2Id === playerId
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tbody = document.getElementById('playerStatsBody');
            tbody.innerHTML = playerHistory.map(entry => {
                const isPlayer1 = entry.player1Id === playerId;
                const opponent = isPlayer1 ? entry.player2 : entry.player1;
                let result, points;
                
                if (entry.resultValue === 0) {
                    result = "Ничья";
                    points = 1;
                } else if (isPlayer1) {
                    result = entry.resultValue === 1 ? "Победа" : "Поражение";
                    points = entry.resultValue === 1 ? 3 : 0;
                } else {
                    result = entry.resultValue === 2 ? "Победа" : "Поражение";
                    points = entry.resultValue === 2 ? 3 : 0;
                }

                return `
                    <tr>
                        <td>${opponent}</td>
                        <td>${result}</td>
                        <td>${points}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>